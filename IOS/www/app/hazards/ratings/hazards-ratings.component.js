"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var core_1 = require('@angular/core');
var componentCommunicationService_1 = require('../../shared/componentCommunicationService');
var localStorageService_1 = require('../../shared/localStorageService');
var validationMessages_1 = require('../../shared/validationMessages');
var hazards_service_1 = require('../shared/hazards.service');
var offline_service_1 = require('../../shared/services/offline.service');
var event_model_1 = require('../../shared/model/event.model');
var location_data_model_1 = require('../../shared/model/location-data.model');
var HazardsRatingsComponent = (function () {
    function HazardsRatingsComponent(service, localStorageService, ccs, offlineService) {
        this.service = service;
        this.localStorageService = localStorageService;
        this.ccs = ccs;
        this.offlineService = offlineService;
        this.hazardCategories = [];
        this.ratingAnswers = [];
        this.hazardsRatings = [];
        this.riLinks = [];
        this.hazardList = [];
        this.riCnt = {};
    }
    HazardsRatingsComponent.prototype.ngOnInit = function () {
        var _this = this;
        this.site = this.localStorageService.get('locationData');
        var rfsParentId = this.site.RFS_PARENT_ID;
        var rfsId = this.site.RFS_ID;
        this.getRatingAnswers();
        this.service.getHazardsData(rfsParentId, rfsId).subscribe(function (data) {
            _this.predominantTS = data.predominantTS;
            var hazardQuesCat = data.hazardsRatings.filter(function (item) { return item.QUESTION_CATEGORY_NM == "Hazards"; });
            _this.hazardsRatings = hazardQuesCat[0]['TQuestion'];
            _this.riLinks = data.riLinks;
            _this.hazardList = data.hazardList;
            _this.getHazardCategories();
            _this.getHazardsRatingCP();
        }, function (err) { return console.error(err); }, function () { });
    };
    HazardsRatingsComponent.prototype.calculateRi = function () {
        var _this = this;
        var _loop_1 = function(i) {
            var hazardCategory = [];
            if (this_1.riLinks[i].LINKED_HAZARDS) {
                var _loop_2 = function(j) {
                    var linkedHazard = this_1.hazardList.find(function (item) { return item.HAZARD_RANDOM_ID_TOLINK == _this.riLinks[i].LINKED_HAZARDS[j]; });
                    var presentFlag = hazardCategory.find(function (item) { return item == linkedHazard.HAZARD_CATEGORY_Desc; });
                    if (!presentFlag) {
                        hazardCategory.push(linkedHazard.HAZARD_CATEGORY_Desc);
                        if (this_1.riCnt[linkedHazard.HAZARD_CATEGORY_Desc]) {
                            this_1.riCnt[linkedHazard.HAZARD_CATEGORY_Desc] = this_1.riCnt[linkedHazard.HAZARD_CATEGORY_Desc] + 1;
                        }
                        else {
                            this_1.riCnt[linkedHazard.HAZARD_CATEGORY_Desc] = 1;
                        }
                    }
                };
                for (var j = 0; j < this_1.riLinks[i].LINKED_HAZARDS.length; j++) {
                    _loop_2(j);
                }
            }
        };
        var this_1 = this;
        for (var i = 0; i < this.riLinks.length; i++) {
            _loop_1(i);
        }
        console.log("----------hazardLinkedList");
        console.log(this.riCnt);
        var _loop_3 = function(k) {
            var hazardCategoryRi = this_2.hazardCategories.find(function (item) { return item.QUESTION_TX == k; });
            if (hazardCategoryRi) {
                hazardCategoryRi.riCount = this_2.riCnt[k];
            }
        };
        var this_2 = this;
        for (var k in this.riCnt) {
            _loop_3(k);
        }
    };
    HazardsRatingsComponent.prototype.getRatingAnswers = function () {
        var _this = this;
        this.service.getRatingAnswers().subscribe(function (data) {
            _this.ratingAnswers = data.filter(function (item) { return item.RatQueCategory == "Hazards - Process & Common"; });
        }, function (err) { return console.error(err); }, function () { });
    };
    HazardsRatingsComponent.prototype.getHazardsRatingCP = function () {
        var _this = this;
        this.service.getHazardsRatingCP().subscribe(function (data) {
            _this.hazardCategories = data.filter(function (item) { return item.OCCUPANCY_CD == _this.predominantTS && item.QUESTION_CATEGORY_NM == "Hazards"; });
            _this.getHazardCategories();
        }, function (err) { return console.error(err); }, function () { });
    };
    HazardsRatingsComponent.prototype.getHazardCategories = function () {
        var _this = this;
        for (var i = 0; i < this.hazardCategories.length; i++) {
            this.hazardCategories[i].currentRatingAns = JSON.parse(JSON.stringify(this.ratingAnswers));
            this.hazardCategories[i].postRatingAns = JSON.parse(JSON.stringify(this.ratingAnswers));
            var _loop_4 = function(j) {
                if (this_3.hazardCategories[i].QUESTION_ID == this_3.hazardsRatings[j].QUESTION_ID) {
                    if (this_3.hazardsRatings[j].Score || this_3.hazardsRatings[j].Score == "0") {
                        var currentRatingObj = this_3.ratingAnswers.filter(function (item) { return item.Scores == _this.hazardsRatings[j].Score; });
                        if (currentRatingObj.length > 0) {
                            this_3.hazardCategories[i].CURRENT_RATING = currentRatingObj[0].RatNarrative;
                        }
                    }
                    if (this_3.hazardsRatings[j].ScoreCPPost || this_3.hazardsRatings[j].ScoreCPPost == "0") {
                        var postRatingObj = this_3.ratingAnswers.filter(function (item) { return item.Scores == _this.hazardsRatings[j].ScoreCPPost; });
                        if (postRatingObj.length > 0) {
                            this_3.hazardCategories[i].POST_RI_RATING = postRatingObj[0].RatNarrative;
                        }
                    }
                }
            };
            var this_3 = this;
            for (var j = 0; j < this.hazardsRatings.length; j++) {
                _loop_4(j);
            }
            if (i == (this.hazardCategories.length - 1)) {
                this.calculateRi();
            }
        }
    };
    HazardsRatingsComponent.prototype.ngOnDestroy = function () {
    };
    HazardsRatingsComponent.prototype.changeCurrentRating = function (currentRating, category) {
        var currentRatingScore = parseInt(currentRating.Scores);
        var site = this.localStorageService.get('locationData');
        category.postRatingAns = [];
        if (currentRatingScore <= 6) {
            category.ratingLow = true;
        }
        for (var i = 0; i < this.ratingAnswers.length; i++) {
            if (parseInt(this.ratingAnswers[i].Scores) >= currentRatingScore) {
                category.postRatingAns.push(this.ratingAnswers[i]);
            }
        }
        this.saveDataToFile(new event_model_1.Event(site.RFS_PARENT_ID, site.RFS_ID, 'save'), category, currentRating.Scores, "current");
    };
    HazardsRatingsComponent.prototype.changePostRating = function (postRating, category) {
        var postRatingScore = parseInt(postRating.Scores);
        var site = this.localStorageService.get('locationData');
        category.currentRatingAns = [];
        for (var i = 0; i < this.ratingAnswers.length; i++) {
            if (parseInt(this.ratingAnswers[i].Scores) <= postRatingScore) {
                category.currentRatingAns.push(this.ratingAnswers[i]);
            }
        }
        this.saveDataToFile(new event_model_1.Event(site.RFS_PARENT_ID, site.RFS_ID, 'save'), category, postRating.Scores, "post");
    };
    HazardsRatingsComponent.prototype.saveDataToFile = function (event, category, score, type) {
        var _this = this;
        var rfsParentId = this.site.RFS_PARENT_ID;
        var rfsId = this.site.RFS_ID;
        if (event.getType() == 'save' && event.getRfsParentId() == rfsParentId && event.getRfsId() == rfsId) {
            this.offlineService.readLocationData(rfsParentId, rfsId).subscribe(function (data) {
                var locData = data;
                var tquestionNumber;
                var questionCategoryData = locData.LocationAssessment.LAWorkPageList[0].AssessmentLocationList[0].LocAssessment.RatingPage.QuestionCategory;
                var hazardIndex = questionCategoryData.findIndex(function (x) { return x.QUESTION_CATEGORY_NM === 'Hazards'; });
                if (category) {
                    for (var i = 0; i < questionCategoryData[hazardIndex].TQuestion.length; i++) {
                        if (questionCategoryData[hazardIndex].TQuestion[i].QUESTION_ID == category.QUESTION_ID) {
                            tquestionNumber = i;
                            break;
                        }
                    }
                    if (locData.LocationAssessment.LAWorkPageList[0].AssessmentLocationList[0].LocAssessment.RatingPage.QuestionCategory[hazardIndex].TQuestion[tquestionNumber]) {
                        if (type == "post") {
                            locData.LocationAssessment.LAWorkPageList[0].AssessmentLocationList[0].LocAssessment.RatingPage.QuestionCategory[hazardIndex].TQuestion[tquestionNumber].ScoreCPPost = "" + score;
                        }
                        else if (type == "current") {
                            locData.LocationAssessment.LAWorkPageList[0].AssessmentLocationList[0].LocAssessment.RatingPage.QuestionCategory[hazardIndex].TQuestion[tquestionNumber].Score = "" + score;
                        }
                    }
                }
                var locationDataModel = new location_data_model_1.LocationDataModel(rfsParentId, rfsId, 'natcat-surge');
                locationDataModel.setRawData(locData);
                _this.offlineService.writeLocationData(locationDataModel);
            });
        }
    };
    HazardsRatingsComponent = __decorate([
        core_1.Component({
            moduleId: module.id,
            selector: 'hazards-ratings',
            templateUrl: 'hazards-ratings.component.html',
            providers: [validationMessages_1.ValidationMessages, hazards_service_1.HazardsService]
        }), 
        __metadata('design:paramtypes', [hazards_service_1.HazardsService, localStorageService_1.LocalStorageService, componentCommunicationService_1.ComponentCommunicationService, offline_service_1.OfflineService])
    ], HazardsRatingsComponent);
    return HazardsRatingsComponent;
}());
exports.HazardsRatingsComponent = HazardsRatingsComponent;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9oYXphcmRzL3JhdGluZ3MvaGF6YXJkcy1yYXRpbmdzLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEscUJBQXlELGVBQWUsQ0FBQyxDQUFBO0FBSXpFLDhDQUE4Qyw0Q0FBNEMsQ0FBQyxDQUFBO0FBRTNGLG9DQUFvQyxrQ0FBa0MsQ0FBQyxDQUFBO0FBQ3ZFLG1DQUFtQyxpQ0FBaUMsQ0FBQyxDQUFBO0FBQ3JFLGdDQUErQiwyQkFBMkIsQ0FBQyxDQUFBO0FBQzNELGdDQUErQix1Q0FBdUMsQ0FBQyxDQUFBO0FBQ3ZFLDRCQUFzQixnQ0FBZ0MsQ0FBQyxDQUFBO0FBQ3ZELG9DQUFrQyx3Q0FBd0MsQ0FBQyxDQUFBO0FBUzNFO0lBU0UsaUNBQW9CLE9BQXNCLEVBQVUsbUJBQXdDLEVBQVUsR0FBaUMsRUFBVSxjQUE4QjtRQUEzSixZQUFPLEdBQVAsT0FBTyxDQUFlO1FBQVUsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQUFVLFFBQUcsR0FBSCxHQUFHLENBQThCO1FBQVUsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBTnZLLHFCQUFnQixHQUFXLEVBQUUsQ0FBQztRQUM5QixrQkFBYSxHQUFXLEVBQUUsQ0FBQztRQUMzQixtQkFBYyxHQUFXLEVBQUUsQ0FBQztRQUM1QixZQUFPLEdBQVcsRUFBRSxDQUFDO1FBQ3JCLGVBQVUsR0FBVyxFQUFFLENBQUM7UUFDeEIsVUFBSyxHQUFZLEVBQUUsQ0FBQztJQUNxSixDQUFDO0lBRWxMLDBDQUFRLEdBQVI7UUFBQSxpQkFzQkM7UUFwQkUsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ3pELElBQUksV0FBVyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDO1FBQzFDLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQzdCLElBQUks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QUQsQ0E1TkEsQUE0TkMsSUFBQTtBQTVOWSwrQkFBdUIsMEJBNE5uQyxDQUFBIiwiZmlsZSI6ImFwcC9oYXphcmRzL3JhdGluZ3MvaGF6YXJkcy1yYXRpbmdzLmNvbXBvbmVudC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0LCBWaWV3Q2hpbGQsIEVsZW1lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuXHJcbmltcG9ydCB7IE1vZGFsRGlyZWN0aXZlIH0gZnJvbSAnLi4vLi4vLi4vc2hhcmVkL21vZGFsL21vZGFsLmNvbXBvbmVudCc7XHJcblxyXG5pbXBvcnQgeyBDb21wb25lbnRDb21tdW5pY2F0aW9uU2VydmljZSB9IGZyb20gJy4uLy4uL3NoYXJlZC9jb21wb25lbnRDb21tdW5pY2F0aW9uU2VydmljZSc7XHJcbmltcG9ydCB7IERyb3Bkb3duQ29udGFpbmVyQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vLi4vc2hhcmVkL2Ryb3Bkb3duQ29udGFpbmVyL2Ryb3Bkb3duLWNvbnRhaW5lci5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBMb2NhbFN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2hhcmVkL2xvY2FsU3RvcmFnZVNlcnZpY2UnO1xyXG5pbXBvcnQgeyBWYWxpZGF0aW9uTWVzc2FnZXMgfSBmcm9tICcuLi8uLi9zaGFyZWQvdmFsaWRhdGlvbk1lc3NhZ2VzJztcclxuaW1wb3J0IHsgSGF6YXJkc1NlcnZpY2UgfSBmcm9tICcuLi9zaGFyZWQvaGF6YXJkcy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgT2ZmbGluZVNlcnZpY2UgfSBmcm9tICcuLi8uLi9zaGFyZWQvc2VydmljZXMvb2ZmbGluZS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRXZlbnQgfSBmcm9tICcuLi8uLi9zaGFyZWQvbW9kZWwvZXZlbnQubW9kZWwnO1xyXG5pbXBvcnQgeyBMb2NhdGlvbkRhdGFNb2RlbCB9IGZyb20gJy4uLy4uL3NoYXJlZC9tb2RlbC9sb2NhdGlvbi1kYXRhLm1vZGVsJztcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIG1vZHVsZUlkOiBtb2R1bGUuaWQsXHJcbiAgc2VsZWN0b3I6ICdoYXphcmRzLXJhdGluZ3MnLFxyXG4gIHRlbXBsYXRlVXJsOiAnaGF6YXJkcy1yYXRpbmdzLmNvbXBvbmVudC5odG1sJyxcclxuICBwcm92aWRlcnM6IFtWYWxpZGF0aW9uTWVzc2FnZXMsIEhhemFyZHNTZXJ2aWNlXVxyXG59KVxyXG5cclxuZXhwb3J0IGNsYXNzIEhhemFyZHNSYXRpbmdzQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3ksIFNhdmVkVG9GaWxlU3lzdGVtIHtcclxuXHJcbiAgcHJpdmF0ZSBwcmVkb21pbmFudFRTOm51bWJlcjtcclxuICBwcml2YXRlIGhhemFyZENhdGVnb3JpZXMgOiBhbnlbXSA9IFtdO1xyXG4gIHByaXZhdGUgcmF0aW5nQW5zd2VycyA6IGFueVtdID0gW107XHJcbiAgcHJpdmF0ZSBoYXphcmRzUmF0aW5ncyA6IGFueVtdID0gW107XHJcbiAgcHJpdmF0ZSByaUxpbmtzIDogYW55W10gPSBbXTtcclxuICBwcml2YXRlIGhhemFyZExpc3QgOiBhbnlbXSA9IFtdO1xyXG4gIHByaXZhdGUgcmlDbnQgOiBPYmplY3QgPSB7fTtcclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHNlcnZpY2U6SGF6YXJkc1NlcnZpY2UsIHByaXZhdGUgbG9jYWxTdG9yYWdlU2VydmljZTogTG9jYWxTdG9yYWdlU2VydmljZSwgcHJpdmF0ZSBjY3M6Q29tcG9uZW50Q29tbXVuaWNhdGlvblNlcnZpY2UsIHByaXZhdGUgb2ZmbGluZVNlcnZpY2U6IE9mZmxpbmVTZXJ2aWNlKXt9XHJcblxyXG4gIG5nT25Jbml0KCkge1xyXG4gIFx0Ly8gdGhpcyBjb21wb25lbnQgaXMgcmVzcG9uc2libGUgZm9yIHJlYWRpbmcgYW5kIHNhdmluZyBkYXRhIGZvciBoYXphcmRzIHJhdGluZyBwYXJ0LlxyXG4gICAgIHRoaXMuc2l0ZSA9IHRoaXMubG9jYWxTdG9yYWdlU2VydmljZS5nZXQoJ2xvY2F0aW9uRGF0YScpO1xyXG4gICAgIGxldCByZnNQYXJlbnRJZCA9IHRoaXMuc2l0ZS5SRlNfUEFSRU5UX0lEO1xyXG4gICAgIGxldCByZnNJZCA9IHRoaXMuc2l0ZS5SRlNfSUQ7XHJcbiAgICAgdGhpcy5nZXRSYXRpbmdBbnN3ZXJzKCk7XHJcbiAgICAgdGhpcy5zZXJ2aWNlLmdldEhhemFyZHNEYXRhKHJmc1BhcmVudElkLCByZnNJZCkuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgLy8gdGhlIGZpcnN0IGFyZ3VtZW50IGlzIGEgZnVuY3Rpb24gd2hpY2ggcnVucyBvbiBzdWNjZXNzXHJcbiAgICAgICAgICBkYXRhID0+IHtcclxuICAgICAgICAgICAgICB0aGlzLnByZWRvbWluYW50VFMgPSBkYXRhLnByZWRvbWluYW50VFM7XHJcbiAgICAgICAgICAgICAgbGV0IGhhemFyZFF1ZXNDYXQgPSBkYXRhLmhhemFyZHNSYXRpbmdzLmZpbHRlcihpdGVtID0+IGl0ZW0uUVVFU1RJT05fQ0FURUdPUllfTk09PVwiSGF6YXJkc1wiKTtcclxuICAgICAgICAgICAgICB0aGlzLmhhemFyZHNSYXRpbmdzID0gaGF6YXJkUXVlc0NhdFswXVsnVFF1ZXN0aW9uJ107XHJcbiAgICAgICAgICAgICAgdGhpcy5yaUxpbmtzID0gZGF0YS5yaUxpbmtzO1xyXG4gICAgICAgICAgICAgIHRoaXMuaGF6YXJkTGlzdCA9IGRhdGEuaGF6YXJkTGlzdDtcclxuICAgICAgICAgICAgICB0aGlzLmdldEhhemFyZENhdGVnb3JpZXMoKTtcclxuICAgICAgICAgICAgICB0aGlzLmdldEhhemFyZHNSYXRpbmdDUCgpO1xyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIC8vIHRoZSBzZWNvbmQgYXJndW1lbnQgaXMgYSBmdW5jdGlvbiB3aGljaCBydW5zIG9uIGVycm9yXHJcbiAgICAgICAgICBlcnIgPT4gY29uc29sZS5lcnJvcihlcnIpLFxyXG4gICAgICAgICAgLy8gdGhlIHRoaXJkIGFyZ3VtZW50IGlzIGEgZnVuY3Rpb24gd2hpY2ggcnVucyBvbiBjb21wbGV0aW9uXHJcbiAgICAgICAgICAoKSA9PiB7fVxyXG4gICAgICApO1xyXG4gIH1cclxuXHJcbiAgY2FsY3VsYXRlUmkoKXtcclxuICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLnJpTGlua3MubGVuZ3RoOyBpKysgKVxyXG4gICAgIHtcclxuICAgICAgIGxldCBoYXphcmRDYXRlZ29yeSA9IFtdO1xyXG4gICAgICAgaWYodGhpcy5yaUxpbmtzW2ldLkxJTktFRF9IQVpBUkRTKVxyXG4gICAgICAge1xyXG4gICAgICAgICAgIGZvcihsZXQgaj0wOyBqPHRoaXMucmlMaW5rc1tpXS5MSU5LRURfSEFaQVJEUy5sZW5ndGg7IGorKylcclxuICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgIGxldCBsaW5rZWRIYXphcmQgPSB0aGlzLmhhemFyZExpc3QuZmluZCggaXRlbSA9PiBpdGVtLkhBWkFSRF9SQU5ET01fSURfVE9MSU5LPT10aGlzLnJpTGlua3NbaV0uTElOS0VEX0hBWkFSRFNbal0pXHJcbiAgICAgICAgICAgICAgIGxldCBwcmVzZW50RmxhZyA9IGhhemFyZENhdGVnb3J5LmZpbmQoaXRlbSA9PiBpdGVtPT1saW5rZWRIYXphcmQuSEFaQVJEX0NBVEVHT1JZX0Rlc2MpO1xyXG4gICAgICAgICAgICAgICBpZighcHJlc2VudEZsYWcpXHJcbiAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICBoYXphcmRDYXRlZ29yeS5wdXNoKGxpbmtlZEhhemFyZC5IQVpBUkRfQ0FURUdPUllfRGVzYyk7XHJcbiAgICAgICAgICAgICAgICAgaWYodGhpcy5yaUNudFtsaW5rZWRIYXphcmQuSEFaQVJEX0NBVEVHT1JZX0Rlc2NdKVxyXG4gICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgIHRoaXMucmlDbnRbbGlua2VkSGF6YXJkLkhBWkFSRF9DQVRFR09SWV9EZXNjXSA9IHRoaXMucmlDbnRbbGlua2VkSGF6YXJkLkhBWkFSRF9DQVRFR09SWV9EZXNjXSsxO1xyXG4gICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICBlbHNle1xyXG4gICAgICAgICAgICAgICAgICAgdGhpcy5yaUNudFtsaW5rZWRIYXphcmQuSEFaQVJEX0NBVEVHT1JZX0Rlc2NdID0gMTtcclxuICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICB9XHJcbiAgICAgICB9XHJcbiAgICAgfVxyXG4gICAgIGNvbnNvbGUubG9nKFwiLS0tLS0tLS0tLWhhemFyZExpbmtlZExpc3RcIik7XHJcbiAgICAgY29uc29sZS5sb2codGhpcy5yaUNudCk7XHJcbiAgICAgZm9yKGxldCBrIGluIHRoaXMucmlDbnQpXHJcbiAgICAge1xyXG4gICAgICAgbGV0IGhhemFyZENhdGVnb3J5UmkgPSB0aGlzLmhhemFyZENhdGVnb3JpZXMuZmluZChpdGVtID0+IGl0ZW0uUVVFU1RJT05fVFg9PWspO1xyXG4gICAgICAgaWYoaGF6YXJkQ2F0ZWdvcnlSaSlcclxuICAgICAgIHtcclxuICAgICAgICAgICBoYXphcmRDYXRlZ29yeVJpLnJpQ291bnQgPSB0aGlzLnJpQ250W2tdOyAgXHJcbiAgICAgICB9XHJcbiAgICAgfVxyXG5cclxuICB9XHJcblxyXG4gIGdldFJhdGluZ0Fuc3dlcnMoKXtcclxuICAgICAgdGhpcy5zZXJ2aWNlLmdldFJhdGluZ0Fuc3dlcnMoKS5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgIC8vIHRoZSBmaXJzdCBhcmd1bWVudCBpcyBhIGZ1bmN0aW9uIHdoaWNoIHJ1bnMgb24gc3VjY2Vzc1xyXG4gICAgICAgICAgICBkYXRhID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJhdGluZ0Fuc3dlcnMgPSBkYXRhLmZpbHRlcihpdGVtID0+IGl0ZW0uUmF0UXVlQ2F0ZWdvcnkgPT0gXCJIYXphcmRzIC0gUHJvY2VzcyAmIENvbW1vblwiKTsgIFxyXG4gICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAvLyB0aGUgc2Vjb25kIGFyZ3VtZW50IGlzIGEgZnVuY3Rpb24gd2hpY2ggcnVucyBvbiBlcnJvclxyXG4gICAgICAgICAgICBlcnIgPT4gY29uc29sZS5lcnJvcihlcnIpLFxyXG4gICAgICAgICAgICAvLyB0aGUgdGhpcmQgYXJndW1lbnQgaXMgYSBmdW5jdGlvbiB3aGljaCBydW5zIG9uIGNvbXBsZXRpb25cclxuICAgICAgICAgICAgKCkgPT4ge31cclxuICAgICAgICApO1xyXG4gIH1cclxuXHJcbiAgXHJcbiAgZ2V0SGF6YXJkc1JhdGluZ0NQKCl7XHJcbiAgICAgIHRoaXMuc2VydmljZS5nZXRIYXphcmRzUmF0aW5nQ1AoKS5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgIC8vIHRoZSBmaXJzdCBhcmd1bWVudCBpcyBhIGZ1bmN0aW9uIHdoaWNoIHJ1bnMgb24gc3VjY2Vzc1xyXG4gICAgICAgICAgICBkYXRhID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGF6YXJkQ2F0ZWdvcmllcyA9IGRhdGEuZmlsdGVyKGl0ZW0gPT4gaXRlbS5PQ0NVUEFOQ1lfQ0QgPT0gdGhpcy5wcmVkb21pbmFudFRTICYmIGl0ZW0uUVVFU1RJT05fQ0FURUdPUllfTk0gPT0gXCJIYXphcmRzXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRIYXphcmRDYXRlZ29yaWVzKCk7XHJcbiAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIC8vIHRoZSBzZWNvbmQgYXJndW1lbnQgaXMgYSBmdW5jdGlvbiB3aGljaCBydW5zIG9uIGVycm9yXHJcbiAgICAgICAgICAgIGVyciA9PiBjb25zb2xlLmVycm9yKGVyciksXHJcbiAgICAgICAgICAgIC8vIHRoZSB0aGlyZCBhcmd1bWVudCBpcyBhIGZ1bmN0aW9uIHdoaWNoIHJ1bnMgb24gY29tcGxldGlvblxyXG4gICAgICAgICAgICAoKSA9PiB7fVxyXG4gICAgICAgICk7XHJcbiAgfVxyXG5cclxuICBnZXRIYXphcmRDYXRlZ29yaWVzKCl7XHJcbiAgICAgIGZvcihsZXQgaT0wOyBpPHRoaXMuaGF6YXJkQ2F0ZWdvcmllcy5sZW5ndGg7IGkrKylcclxuICAgICAge1xyXG4gICAgICAgICAgdGhpcy5oYXphcmRDYXRlZ29yaWVzW2ldLmN1cnJlbnRSYXRpbmdBbnMgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMucmF0aW5nQW5zd2VycykpO1xyXG4gICAgICAgICAgdGhpcy5oYXphcmRDYXRlZ29yaWVzW2ldLnBvc3RSYXRpbmdBbnMgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMucmF0aW5nQW5zd2VycykpO1xyXG4gICAgICAgICAgZm9yKGxldCBqPTA7IGo8dGhpcy5oYXphcmRzUmF0aW5ncy5sZW5ndGg7IGorKylcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgaWYodGhpcy5oYXphcmRDYXRlZ29yaWVzW2ldLlFVRVNUSU9OX0lEPT10aGlzLmhhemFyZHNSYXRpbmdzW2pdLlFVRVNUSU9OX0lEKVxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICBpZih0aGlzLmhhemFyZHNSYXRpbmdzW2pdLlNjb3JlIHx8IHRoaXMuaGF6YXJkc1JhdGluZ3Nbal0uU2NvcmU9PVwiMFwiKVxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBjdXJyZW50UmF0aW5nT2JqID0gdGhpcy5yYXRpbmdBbnN3ZXJzLmZpbHRlcihpdGVtID0+IGl0ZW0uU2NvcmVzPT10aGlzLmhhemFyZHNSYXRpbmdzW2pdLlNjb3JlKTtcclxuICAgICAgICAgICAgICAgICAgICBpZihjdXJyZW50UmF0aW5nT2JqLmxlbmd0aD4wKVxyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGF6YXJkQ2F0ZWdvcmllc1tpXS5DVVJSRU5UX1JBVElORyA9IGN1cnJlbnRSYXRpbmdPYmpbMF0uUmF0TmFycmF0aXZlOyAgXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYodGhpcy5oYXphcmRzUmF0aW5nc1tqXS5TY29yZUNQUG9zdCB8fCB0aGlzLmhhemFyZHNSYXRpbmdzW2pdLlNjb3JlQ1BQb3N0PT1cIjBcIilcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgbGV0IHBvc3RSYXRpbmdPYmogPSB0aGlzLnJhdGluZ0Fuc3dlcnMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5TY29yZXM9PXRoaXMuaGF6YXJkc1JhdGluZ3Nbal0uU2NvcmVDUFBvc3QpO1xyXG4gICAgICAgICAgICAgICAgICBpZihwb3N0UmF0aW5nT2JqLmxlbmd0aD4wKVxyXG4gICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYXphcmRDYXRlZ29yaWVzW2ldLlBPU1RfUklfUkFUSU5HID0gcG9zdFJhdGluZ09ialswXS5SYXROYXJyYXRpdmU7XHJcbiAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgaWYoaT09KHRoaXMuaGF6YXJkQ2F0ZWdvcmllcy5sZW5ndGgtMSkpXHJcbiAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgdGhpcy5jYWxjdWxhdGVSaSgpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICAgXHJcbiAgfVxyXG5cclxuICBjaGFuZ2VDdXJyZW50UmF0aW5nKGN1cnJlbnRSYXRpbmcsY2F0ZWdvcnkpe1xyXG4gICAgICBsZXQgY3VycmVudFJhdGluZ1Njb3JlID0gcGFyc2VJbnQoY3VycmVudFJhdGluZy5TY29yZXMpO1xyXG4gICAgICBsZXQgc2l0ZSA9IHRoaXMubG9jYWxTdG9yYWdlU2VydmljZS5nZXQoJ2xvY2F0aW9uRGF0YScpO1xyXG4gICAgICBjYXRlZ29yeS5wb3N0UmF0aW5nQW5zID0gW107XHJcbiAgICAgIGlmKGN1cnJlbnRSYXRpbmdTY29yZTw9NilcclxuICAgICAge1xyXG4gICAgICAgICAgY2F0ZWdvcnkucmF0aW5nTG93ID0gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgICBmb3IobGV0IGk9MDsgaSA8IHRoaXMucmF0aW5nQW5zd2Vycy5sZW5ndGg7IGkrKylcclxuICAgICAge1xyXG4gICAgICAgICBpZihwYXJzZUludCh0aGlzLnJhdGluZ0Fuc3dlcnNbaV0uU2NvcmVzKT49Y3VycmVudFJhdGluZ1Njb3JlKVxyXG4gICAgICAgICB7XHJcbiAgICAgICAgICAgIGNhdGVnb3J5LnBvc3RSYXRpbmdBbnMucHVzaCh0aGlzLnJhdGluZ0Fuc3dlcnNbaV0pO1xyXG4gICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgIFxyXG4gICAgICB0aGlzLnNhdmVEYXRhVG9GaWxlKG5ldyBFdmVudChzaXRlLlJGU19QQVJFTlRfSUQsIHNpdGUuUkZTX0lELCAnc2F2ZScpLGNhdGVnb3J5LGN1cnJlbnRSYXRpbmcuU2NvcmVzLFwiY3VycmVudFwiKTtcclxuICAgICAgXHJcbiAgfVxyXG5cclxuICBjaGFuZ2VQb3N0UmF0aW5nKHBvc3RSYXRpbmcsY2F0ZWdvcnkpe1xyXG4gICAgICBsZXQgcG9zdFJhdGluZ1Njb3JlID0gcGFyc2VJbnQocG9zdFJhdGluZy5TY29yZXMpO1xyXG4gICAgICBsZXQgc2l0ZSA9IHRoaXMubG9jYWxTdG9yYWdlU2VydmljZS5nZXQoJ2xvY2F0aW9uRGF0YScpO1xyXG4gICAgICBjYXRlZ29yeS5jdXJyZW50UmF0aW5nQW5zID0gW107XHJcbiAgICAgIGZvcihsZXQgaT0wOyBpIDwgdGhpcy5yYXRpbmdBbnN3ZXJzLmxlbmd0aDsgaSsrKVxyXG4gICAgICB7XHJcbiAgICAgICAgIGlmKHBhcnNlSW50KHRoaXMucmF0aW5nQW5zd2Vyc1tpXS5TY29yZXMpPD1wb3N0UmF0aW5nU2NvcmUpXHJcbiAgICAgICAgIHtcclxuICAgICAgICAgICAgY2F0ZWdvcnkuY3VycmVudFJhdGluZ0Fucy5wdXNoKHRoaXMucmF0aW5nQW5zd2Vyc1tpXSk7XHJcbiAgICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICAgXHJcbiAgICAgIHRoaXMuc2F2ZURhdGFUb0ZpbGUobmV3IEV2ZW50KHNpdGUuUkZTX1BBUkVOVF9JRCwgc2l0ZS5SRlNfSUQsICdzYXZlJyksY2F0ZWdvcnkscG9zdFJhdGluZy5TY29yZXMsXCJwb3N0XCIpO1xyXG4gIH1cclxuXHJcbiAgc2F2ZURhdGFUb0ZpbGUoZXZlbnQsY2F0ZWdvcnksc2NvcmUsdHlwZSkge1xyXG4gICAgICAgIGxldCByZnNQYXJlbnRJZCA9IHRoaXMuc2l0ZS5SRlNfUEFSRU5UX0lEO1xyXG4gICAgICAgIGxldCByZnNJZCA9IHRoaXMuc2l0ZS5SRlNfSUQ7XHJcblxyXG4gICAgICAgIGlmIChldmVudC5nZXRUeXBlKCkgPT0gJ3NhdmUnICYmIGV2ZW50LmdldFJmc1BhcmVudElkKCkgPT0gcmZzUGFyZW50SWQgJiYgZXZlbnQuZ2V0UmZzSWQoKSA9PSByZnNJZCkge1xyXG5cclxuICAgICAgICAgICAgdGhpcy5vZmZsaW5lU2VydmljZS5yZWFkTG9jYXRpb25EYXRhKHJmc1BhcmVudElkLCByZnNJZCkuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgZGF0YSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGxvY0RhdGEgPSBkYXRhO1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCB0cXVlc3Rpb25OdW1iZXIgOm51bWJlcjtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgcXVlc3Rpb25DYXRlZ29yeURhdGEgPSBsb2NEYXRhLkxvY2F0aW9uQXNzZXNzbWVudC5MQVdvcmtQYWdlTGlzdFswXS5Bc3Nlc3NtZW50TG9jYXRpb25MaXN0WzBdLkxvY0Fzc2Vzc21lbnQuUmF0aW5nUGFnZS5RdWVzdGlvbkNhdGVnb3J5O1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBoYXphcmRJbmRleCA9IHF1ZXN0aW9uQ2F0ZWdvcnlEYXRhLmZpbmRJbmRleCh4ID0+IHguUVVFU1RJT05fQ0FURUdPUllfTk0gPT09ICdIYXphcmRzJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgaWYoY2F0ZWdvcnkpXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBpPTA7IGk8IHF1ZXN0aW9uQ2F0ZWdvcnlEYXRhW2hhemFyZEluZGV4XS5UUXVlc3Rpb24ubGVuZ3RoOyBpKysgKVxyXG4gICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHF1ZXN0aW9uQ2F0ZWdvcnlEYXRhW2hhemFyZEluZGV4XS5UUXVlc3Rpb25baV0uUVVFU1RJT05fSUQ9PWNhdGVnb3J5LlFVRVNUSU9OX0lEKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRxdWVzdGlvbk51bWJlciA9IGk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgaWYobG9jRGF0YS5Mb2NhdGlvbkFzc2Vzc21lbnQuTEFXb3JrUGFnZUxpc3RbMF0uQXNzZXNzbWVudExvY2F0aW9uTGlzdFswXS5Mb2NBc3Nlc3NtZW50LlJhdGluZ1BhZ2UuUXVlc3Rpb25DYXRlZ29yeVtoYXphcmRJbmRleF0uVFF1ZXN0aW9uW3RxdWVzdGlvbk51bWJlcl0pe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZih0eXBlPT1cInBvc3RcIilcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGxvY0RhdGEuTG9jYXRpb25Bc3Nlc3NtZW50LkxBV29ya1BhZ2VMaXN0WzBdLkFzc2Vzc21lbnRMb2NhdGlvbkxpc3RbMF0uTG9jQXNzZXNzbWVudC5SYXRpbmdQYWdlLlF1ZXN0aW9uQ2F0ZWdvcnlbaGF6YXJkSW5kZXhdLlRRdWVzdGlvblt0cXVlc3Rpb25OdW1iZXJdLlNjb3JlQ1BQb3N0ID0gXCJcIitzY29yZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmKHR5cGU9PVwiY3VycmVudFwiKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jRGF0YS5Mb2NhdGlvbkFzc2Vzc21lbnQuTEFXb3JrUGFnZUxpc3RbMF0uQXNzZXNzbWVudExvY2F0aW9uTGlzdFswXS5Mb2NBc3Nlc3NtZW50LlJhdGluZ1BhZ2UuUXVlc3Rpb25DYXRlZ29yeVtoYXphcmRJbmRleF0uVFF1ZXN0aW9uW3RxdWVzdGlvbk51bWJlcl0uU2NvcmUgPSBcIlwiK3Njb3JlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIGxldCBsb2NhdGlvbkRhdGFNb2RlbCA9IG5ldyBMb2NhdGlvbkRhdGFNb2RlbChyZnNQYXJlbnRJZCwgcmZzSWQsICduYXRjYXQtc3VyZ2UnKTtcclxuICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbkRhdGFNb2RlbC5zZXRSYXdEYXRhKGxvY0RhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMub2ZmbGluZVNlcnZpY2Uud3JpdGVMb2NhdGlvbkRhdGEobG9jYXRpb25EYXRhTW9kZWwpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgXHJcbn1cclxuIl19
